<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="/images/favicon_cigusto.png">
    <title>Cigusto - Teal Gestion produits</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- SIDEBAR -->
    <!-- jQuery CDN - Slim version (=without AJAX) -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <!-- Popper.JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js" integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ" crossorigin="anonymous"></script>
    <!-- Bootstrap JS -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js" integrity="sha384-uefMccjFJAIv6A+rW+L4AHf99KvxDjWSu1z9VI8SKNVmz4sk7buKt/6v9KI65qnm" crossorigin="anonymous"></script>
    <!-- jQuery Custom Scroller CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/malihu-custom-scrollbar-plugin/3.1.5/jquery.mCustomScrollbar.concat.min.js"></script>
</head>
<body>
<!--ecran pc-->
    <div style="background-color: white; box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);">
        <br><br>
        <a style="color: inherit;">
            <button class="btn-gestion" style="width: 15%;" onclick="goBack()">
                <i class="bi bi-chevron-double-left"></i> Retour
            </button>
        </a>
        <input type="checkbox" id="show-only-null" style="transform: scale(1.5); margin-right: 10px; margin-left: 30px;"><label style="font-size: 1.2em;" for="show-only-null">Produits incomplets</label>
        <br><br><br>
    </div>
    <br>
    <div id="table-container"></div>
</body>
</html>

<script>
    function goBack() {
        window.history.back();
    }

    // Fonction pour filtrer les produits avec des valeurs null
    function filterProducts() {
        const rows = document.querySelectorAll('tbody tr');
        const showOnlyNull = document.getElementById('show-only-null').checked;
        // affiche les produits avec une valeur null ou masque
        rows.forEach(row => {
            const alertCell = row.querySelector('.alert-cell');
            row.style.display = showOnlyNull && alertCell ? 'table-row' : 'none';
        });
        if (!showOnlyNull) {
            rows.forEach(row => {
                row.style.display = 'table-row';
            });
        }
    }

    function dropdownCells(selectedValue, options, column, onChange){
        const cell = document.createElement('td');
        const select = document.createElement('select');

        options.forEach(optionValue => {
            const option = document.createElement('option');
            option.value = optionValue.value;
            option.textContent = optionValue.label;

            if (optionValue.value === selectedValue) {
                option.selected = true;
            }

            select.appendChild(option);
        });

        select.addEventListener('change', event => {
            onChange(event, column);
        });
        cell.appendChild(select);

        return cell;
    }

    fetch(`/gestion-produits/all-stores`)
        .then(response => response.json())
        .then(data => {
            const tableContainer = document.getElementById('table-container');

            const table = document.createElement('table');
            table.classList.add('table');

            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');

            const headers = [
                'Magasin ID',
                'SKU',
                'Libellé produit',
                'Libellé fiche',
                'Catégorie ID',
                'Marque ID',
                'Type saveur ID',
                'Description',
                'Dosage PG/VG ID',
                'Contenance ml ID',
                'Dosage nicotine mg ID',
                'Sel de nicotine',
                'Quantité en stock',
                'Statut produit ID',
                'Alerte infos',
                'Actions'
            ];

            headers.forEach(headerText => {
                const header = document.createElement('th');
                header.textContent = headerText;
                headerRow.appendChild(header);
            });

            thead.appendChild(headerRow);
            table.appendChild(thead);

            const tbody = document.createElement('tbody');

            data.forEach(product => {
                const row = document.createElement('tr');

                function handleChange(event, column) {
                    const selectedValue = event.target.value;
                    switch (column) {
                        case 'magasin_id':
                            // créer une requete UPDATE => mise a jour produit bdd avec btn valider / activer le btn valider
                            console.log('ID de magasin sélectionné :', selectedValue);
                            product.magasin_id = selectedValue;
                            break;
                        case 'categorie_id':
                            // créer une requete UPDATE => mise a jour produit bdd avec btn valider / activer le btn valider
                            console.log('ID de catégorie sélectionnée :', selectedValue);
                            product.categorie_id = selectedValue;
                            break;
                        case 'marque_id':
                            // créer une requete UPDATE => mise a jour produit bdd avec btn valider / activer le btn valider
                            console.log('ID de la marque sélectionnée :', selectedValue);
                            product.marque_id = selectedValue;
                            break;
                        case 'type_saveur_id':
                            // créer une requete UPDATE => mise a jour produit bdd avec btn valider / activer le btn valider
                            console.log('ID de la saveur sélectionnée :', selectedValue);
                            product.type_saveur_id = selectedValue;
                            break;
                        case 'dosage_pg_vg_id':
                            // créer une requete UPDATE => mise a jour produit bdd avec btn valider / activer le btn valider
                            console.log('ID du dosage PV/VG sélectionné :', selectedValue);
                            product.dosage_pg_vg_id = selectedValue;
                            break;
                        case 'contentenance_ml_id':
                            // créer une requete UPDATE => mise a jour produit bdd avec btn valider / activer le btn valider
                            console.log('ID de la contenance sélectionnée :', selectedValue);
                            product.contentenance_ml_id = selectedValue;
                            break;
                        case 'dosage_nicotine_mg_id':
                            // créer une requete UPDATE => mise a jour produit bdd avec btn valider / activer le btn valider
                            console.log('ID du dosage nicotine sélectionné :', selectedValue);
                            product.dosage_nicotine_mg_id = selectedValue;
                            break;
                        case 'statut_produit_id':
                            // créer une requete UPDATE => mise a jour produit bdd avec btn valider / activer le btn valider
                            console.log('ID du statut produit sélectionné :', selectedValue);
                            product.statut_produit_id = selectedValue;
                            break;
                    }
                }

                const cells = [
                    product.magasin_id,
                    product.sku,
                    product.libelle_produit,
                    product.libelle_fiche,
                    product.categorie_id,
                    product.marque_id,
                    product.type_saveur_id,
                    product.description,
                    product.dosage_pg_vg_id,
                    product.contenance_ml_id,
                    product.dosage_nicotine_mg_id,
                    product.sel_de_nicotine,
                    product.qte_stock,
                    product.statut_produit_id
                ];

                let hasNullValue = false;

                const magasinOptions = [
                    { value: null, label: '' },
                    { value: 1, label: 'Andelnans' },
                    { value: 2, label: 'Besançon' },
                    { value: 3, label: 'Bessoncourt' },
                    { value: 4, label: 'Colmar' }
                ];
                const categorieOptions = [
                    { value: null, label: '' },
                    { value: 1, label: 'Liquides 10 ml' },
                    { value: 2, label: 'Liquides Grand Format' },
                    { value: 3, label: 'Concentrés' }
                ];
                const marqueOptions = [
                    { value: null, label: '' },
                    { value: 1, label: 'A&L' },
                    { value: 2, label: 'Alfaliquid' },
                    { value: 3, label: 'Bakery Shake' },
                    { value: 4, label: 'Candy Shake' },
                    { value: 5, label: 'Cesar' },
                    { value: 6, label: 'Cigusto' },
                    { value: 7, label: 'CirKus' },
                    { value: 8, label: 'Curieux' },
                    { value: 9, label: 'Don Cristo' },
                    { value: 10, label: 'Eliquid France' },
                    { value: 11, label: 'Enfer' },
                    { value: 12, label: 'E.Tasty' },
                    { value: 13, label: 'Fresh Vape Co' },
                    { value: 14, label: 'Fruiteo' },
                    { value: 15, label: 'Fruity Cool' },
                    { value: 16, label: 'Fruity Fuel' },
                    { value: 17, label: 'Fruizee' },
                    { value: 18, label: 'Full Moon' },
                    { value: 19, label: 'Furiosa' },
                    { value: 20, label: 'Greeneo' },
                    { value: 21, label: 'Juicy Shake' },
                    { value: 22, label: 'Kung Fruits' },
                    { value: 23, label: 'Le Coq Qui Vape' },
                    { value: 24, label: 'Le French Liquide' },
                    { value: 25, label: 'Le Vapoteur Breton' },
                    { value: 26, label: 'Les Devils' },
                    { value: 27, label: 'Liquideo' },
                    { value: 28, label: 'Mono' },
                    { value: 29, label: 'Monster' },
                    { value: 30, label: 'Petit Nuage' },
                    { value: 31, label: 'Salt E-vapor' },
                    { value: 32, label: 'Snap Dragon' },
                    { value: 33, label: 'Swoke' },
                    { value: 34, label: 'The Medusa Juice' },
                    { value: 35, label: 'T-Juice' },
                    { value: 36, label: 'Vampire Vape' },
                    { value: 37, label: 'Vape Distillery' },
                    { value: 38, label: 'VDLV' },
                    { value: 39, label: 'Amazone' },
                    { value: 40, label: 'Aromazon' },
                    { value: 41, label: 'Doctor Diy' },
                    { value: 42, label: 'Fighter Fuel' },
                    { value: 43, label: 'Kyandi Shop' },
                    { value: 44, label: 'Shootiz' },
                    { value: 45, label: 'Vape47' }
                ];
                const saveurOptions = [
                    { value: null, label: '' },
                    { value: 1, label: 'Classic' },
                    { value: 2, label: 'Mentholé' },
                    { value: 3, label: 'Fruité' },
                    { value: 4, label: 'Fruité Frais' },
                    { value: 5, label: 'Gourmand' },
                    { value: 6, label: 'Friandise / Boisson' }
                ];
                const dosagepgvgOptions = [
                    { value: null, label: '' },
                    { value: 1, label: '10/90' },
                    { value: 2, label: '20/80' },
                    { value: 3, label: '30/70' },
                    { value: 4, label: '40/60' },
                    { value: 5, label: '50/50' },
                    { value: 6, label: '60/40' },
                    { value: 7, label: '70/30' },
                    { value: 8, label: '76/24' }
                ];
                const contenanceOptions = [
                    { value: null, label: '' },
                    { value: 1, label: '10 ml' },
                    { value: 2, label: '30 ml' },
                    { value: 3, label: '50 ml' },
                    { value: 4, label: '80 ml' },
                    { value: 5, label: '100 ml' },
                    { value: 6, label: '200 ml' }
                ];
                const dosageNicotineOptions = [
                    { value: null, label: '' },
                    { value: 1, label: '0 mg' },
                    { value: 2, label: '3 mg' },
                    { value: 3, label: '6 mg' },
                    { value: 4, label: '9-10 mg' },
                    { value: 5, label: '12 mg' },
                    { value: 6, label: '18 mg' },
                    { value: 7, label: '18-20 mg' }
                ];
                const statutProduitOptions = [
                    { value: null, label: '' },
                    { value: 1, label: 'Actif' },
                    { value: 2, label: 'Inactif' },
                    { value: 3, label: 'Fin d\'approvisionnement' }
                ];

                cells.forEach((cellData, index) => {
                    let cell;
                    if (index === 0) { // Magasin ID
                        cell = dropdownCells(cellData, magasinOptions, 'magasin_id', handleChange);
                    } else if (index === 4) { // Catégorie ID
                        cell = dropdownCells(cellData, categorieOptions, 'categorie_id', handleChange);
                    } else if (index === 5) { // Marque ID
                        cell = dropdownCells(cellData, marqueOptions, 'marque_id', handleChange);
                    } else if (index === 6) { // Type Saveur ID
                        cell = dropdownCells(cellData, saveurOptions, 'type_saveur_id', handleChange);
                    } else if (index === 8) { // Dosage PG/VG
                        cell = dropdownCells(cellData, dosagepgvgOptions, 'dosage_pg_vg_id', handleChange);
                    } else if (index === 9) { // Constenance ml ID
                        cell = dropdownCells(cellData, contenanceOptions, 'contentenance_ml_id', handleChange);
                    } else if (index === 10) { // Dosage nicotine mg ID
                        cell = dropdownCells(cellData, dosageNicotineOptions, 'dosage_nicotine_mg_id', handleChange);
                    } else if (index === 13) { // Statut produit ID
                        cell = dropdownCells(cellData, statutProduitOptions, 'statut_produit_id', handleChange);
                    } else {
                        cell = document.createElement('td');
                        cell.textContent = cellData;
                    }

                    if (cellData === null && index !== 0) {
                        cell.style.backgroundColor = 'red';
                        hasNullValue = true;
                    }
                    if (cellData === null && index === 0) {
                        cell.style.backgroundColor = 'gray';
                    }
                    row.appendChild(cell);
                });

                // vérifier si le produit a des valeurs null
                if (hasNullValue) {
                    const alertCell = document.createElement('td');
                    alertCell.textContent = 'Information(s) manquante(s)';
                    alertCell.style.color = 'white';
                    alertCell.style.backgroundColor = 'red';
                    alertCell.classList.add('alert-cell');
                    row.appendChild(alertCell);
                } else {
                    const emptyCell = document.createElement('td');
                    row.appendChild(emptyCell);
                }









                const actionsCell = document.createElement('td');
                const validateButton = document.createElement('button');
                validateButton.textContent = 'Valider';
                validateButton.addEventListener('click', () => {
                    const selectedId = product.id;
                    const selectedMagasinId = product.magasin_id;
                    const selectedCategorieId = product.categorie_id;
                    const selectedMarqueId = product.marque_id;
                    const selectedTypeSaveurId = product.type_saveur_id;
                    const selectedDosagePgVgId = product.dosage_pg_vg_id;
                    const selectedContentenanceMlId = product.contentenance_ml_id;
                    const selectedDosageNicotineMgId = product.dosage_nicotine_mg_id;
                    const selectedStatutProduitId = product.statut_produit_id;

                    // envoie les ids à update dans la base de données au back-end
                    fetch('/gestion-produits/update', {
                        method: 'POST',
                        body: JSON.stringify({
                            id: selectedId,
                            magasin_id: selectedMagasinId,
                            categorie_id: selectedCategorieId,
                            marque_id: selectedMarqueId,
                            type_saveur_id: selectedTypeSaveurId,
                            dosage_pg_vg_id: selectedDosagePgVgId,
                            contentenance_ml_id: selectedContentenanceMlId,
                            dosage_nicotine_mg_id: selectedDosageNicotineMgId,
                            statut_produit_id: selectedStatutProduitId
                        }),
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                        .then(response => response.json())
                        .then(data => {
                            // console.log('Réponse de la requête:', data);
                        })
                        .catch(error => {
                            console.error('Une erreur s\'est produite lors de la requête:', error);
                        });
                });
                actionsCell.appendChild(validateButton);
                row.appendChild(actionsCell);






                tbody.appendChild(row);
            });
            table.appendChild(tbody);
            tableContainer.appendChild(table);

            const checkbox = document.getElementById('show-only-null');
            checkbox.addEventListener('change', filterProducts);
        })
        .catch(error => {
            console.error('Une erreur s\'est produite lors de la récupération des données:', error);
        });
</script>

<style>
    body {
        background-color: #F2F2F2;
    }
    .btn-gestion {
        background-color: #F9533E;
        color: black;
        border-radius: 10px;
        padding: 10px 20px;
        border: none;
        font-size: 1.2em;
        font-weight: bold;
        transition: background-color 0.5s;
    }
    .btn-gestion:hover {
        background-color: black;
        color: white;
    }
</style>